name: Build, Tag e Deploy para Hostinger

on:
  push:
    branches:
      - 'release/**'

jobs:
  build-tag-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Instalar dependências
        run: npm ci

      - name: Criar arquivo .env no runner
        run: |
          echo "ROOT_PATH_PROD=${{ vars.ROOT_PATH_PROD }}" >> .env
          echo "SSW_API_URL_PROD=${{ vars.SSW_API_URL_PROD }}" >> .env

      - name: Build do projeto
        run: npm run build-prod

      - name: Verificar conteúdo do dist
        run: ls -R ./dist

      - name: Ler versão do package.json
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Buscar última tag para essa versão
        id: get_latest_tag
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAGS=$(git ls-remote --tags origin "refs/tags/$VERSION-*" | sed 's/.*\/\///' | sort -V)
          echo "Tags existentes:"
          echo "$TAGS"

          LAST=$(echo "$TAGS" | grep "^$VERSION-" | sed "s/^$VERSION-//" | sort -n | tail -n 1)
          if [ -z "$LAST" ]; then
            NEXT=1
          else
            NEXT=$((LAST + 1))
          fi

          NEW_TAG="$VERSION-$NEXT"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Criar e enviar tag
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          TAG=${{ steps.get_latest_tag.outputs.new_tag }}
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "$TAG"
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/Valmirzaodasilva/phex-portal.git
          git push origin "$TAG"

      - name: Limpar cache de deploy FTP
        run: rm -f .ftp-deploy-sync-state.json

      - name: Deploy via FTP para Hostinger
        uses: SamKirkland/FTP-Deploy-Action@4.1.0
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./dist/phex-portal/
          server-dir: ./
          delete: true

      - name: Fazer merge para main
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          RELEASE_BRANCH=$(echo "${GITHUB_REF#refs/heads/}")
          echo "Fazendo merge de $RELEASE_BRANCH para main"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/Valmirzaodasilva/phex-portal.git
          git fetch origin main
          git checkout main
          git merge origin/$RELEASE_BRANCH --no-edit
          git push origin main
